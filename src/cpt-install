#!/bin/sh
# Install a package

# shellcheck disable=1091
if [ -f ./cpt-lib ]; then . ./cpt-lib; else . cpt-lib; fi

parser_definition() {
    setup REST -- "usage: ${0##*/} [pkg...]"
    msg -- '' 'Options:'
    flag  CPT_FORCE -f --force init:="$CPT_FORCE" -- "Force installation"
    param CPT_ROOT     --root  init:="$CPT_ROOT"  -- "Use an alternate root directory"
    disp  :usage    -h --help                     -- "Show this help message"
    disp  :version  -v --version                  -- "Print version information"
}

eval "$(getoptions      parser_definition parse "$0")"
eval "$(getoptions_help parser_definition usage "$0")"

parse "$@"
eval set -- "$REST"

[ "$1" ] || set -- "${PWD##*/}"; export CPT_PATH=${PWD%/*}:$CPT_PATH

[ -w "$CPT_ROOT/" ] || [ "$uid" = 0 ] || {
    as_root "$0" "$@"
    exit $?
}

pkg_order "$@"

create_cache

# shellcheck disable=2154
for pkg in $order; do pkg_install "$pkg"; done

# After installation is complete, show a list of messages from packages.
log "Retrieving post-installation message queue"
unset msg

for pkg in $order; do
    [ -f "$sys_db/$pkg/message" ] && {
        printf '%s\n%s\n%s\n\n' \
               "=======================================" \
               "$pkg" \
               "======================================="
        cat "$sys_db/$pkg/message" >&2
        msg=1
    }
done
[ "$msg" ] || log "No message in queue"
